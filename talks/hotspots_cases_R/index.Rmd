---
title: "Hotspots de la Transmisión de Dengue en R"
author: "Felipe Antonio Dzul Manzanilla"
date: '2022: Last compiled `r Sys.Date()`'
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: 
      - default
      - default-fonts
      - duke-blue
      - hygge-duke
      - libs/cc-fonts.css
      - libs/figure-captions.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

class: left, top

```{r xaringan-fit-screen, echo=FALSE}
xaringanExtra::use_fit_screen()
```

```{r xaringanExtra, echo = FALSE}
xaringanExtra::use_progress_bar(color = "#0051BA", location = "top")
```

```{r xaringan-tachyons, echo=FALSE}
xaringanExtra::use_tachyons()
```

```{r share-again, echo=FALSE}
xaringanExtra::use_share_again()
```

```{r xaringan-logo, echo=FALSE}
xaringanExtra::use_logo(
  image_url = "https://www.gob.mx/cms/uploads/action_program/main_image/26942/post_post_portadavectores.gif",
  width = "110px",
  height = "228px",
  position = xaringanExtra::css_position(top = "1em", right = "1em")
)
```

# **Cálculo de los Hotspots de Dengue**

.pull-left[

```{r, dpi=300,echo=FALSE, fig.align ="center", out.width = "100%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  
  # flowchart for hotspots
  sinave [label = 'SINAVE',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  denv [label = 'Bases de DENV',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  geocode [label = 'Geocodificación',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  cases_ageb [label = 'Casos por AGEBs']
  z_score [label = 'Z-score']
  gi [label = 'Estadístico Espacial Local (Gi*)']
  bonferroni [label = 'Corrección de Bonferroni']
  hotspots [label = 'Hotspots', style = filled, color = orange]
  
  # flow chart for inegi
  inegi [label = 'INEGI', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  loc [label = 'Localidades Shapefile', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  ageb [label = 'AGEB Shapefile', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  loc_esp [label = 'Localidad de Ínteres', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  ageb_esp [label = 'AGEBs de la Localidad de Ínteres', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  mat [label = 'Matriz de Adjacencias', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  
  # edge definitions with the node IDs
  edge [color = black]
  sinave -> denv -> geocode -> cases_ageb -> z_score -> gi -> bonferroni -> hotspots 
  inegi -> {ageb, loc}
  loc -> loc_esp -> ageb_esp
  ageb -> ageb_esp
  ageb_esp -> mat
  mat -> cases_ageb 
 
  }", 
  height = 550)

```


]
.pull-right[

```{r,  dpi=300,echo=FALSE, fig.align ="center", out.width = "100%"}
DiagrammeR::grViz("digraph {


# graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  
  # flowchart for hotspots
  sinave [label = 'SINAVE',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  denv [label = 'DENV dataset',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  
   geocode [label = 'Geocoding',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
   cases_ageb [label = 'Cases/AGEB',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
   hotspots [label = 'Hotspots Analysis',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
   vizualization [label = 'Visualization',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
   static [label = 'Static Map',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
   interactive [label = 'Interactive Map',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
  
  # edge definitions with the node IDs
  edge [color = black]
  sinave -> denv -> geocode -> cases_ageb -> hotspots -> vizualization -> {static interactive}
  

}",
height = 550)
```

]


---
# **Geocodificación de las bases de dengue en R**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">


## 0. Darse de alta en el servicio de Geocoding API de google 
&nbsp;
## 1. Subir las bases de dengue.
&nbsp;
## 2. Geocodificar las bases de dengue.
&nbsp;
## 3. Unir las bases de dengue.


---

# **Geocodificación**

```{r xaringan-panelset_geocoding, echo=FALSE}
xaringanExtra::use_panelset()
```

.panelset[

.panel[.panel-name[Paso 1. Load dataset]
```{r geocoding_step_1, fig.show='hide', warning=FALSE, message=FALSE}

# Step 1. Subir la base de datos de dengue de la semana pasada #####
# y  <- denhotspots::read_dengue_dataset() 

# Step 2. Subir la base de datos de dengue de la semana actual ####
# x  <- denhotspots::read_dengue_dataset() 


# Step 3. extraer los casos (ids) no geocodificados de la semana actual ###
#z <- x |>
#    dplyr::filter(!VEC_ID %in% c(y$VEC_ID)) |>
#    dplyr::arrange(VEC_ID)


# Step 4. guardar los resultados ####
#write.csv(z, file = "positive_denmx_2022_10_17.csv")


```
]

.panel[.panel-name[Paso 2. Geocoding]
```{r geocoding_step_2, fig.show='hide', warning=FALSE, message=FALSE}
# Step 1. apply the vector addreses ####
#addresses <- denhotspots::data_geocoden(infile = "positive_denmx_2022_10_17",
#                                        data = FALSE,
#                                        sinave_new = TRUE)
# Step 2. text manipulation ####
#stringr::str_subset(addresses, "(?<=Colonia ).+(?= CENTRO)")
#addresses <- stringr::str_replace_all(addresses,
#                                      pattern = " VER,",
#                                      replacement = " ,")
# Step 3. geocoding ###
#library(ggmap)
#denhotspots::geocoden(infile = "positive_denmx_2022_10_17")
# Step 4. load the dengue geocoded & dengue dataset #####
#z <- readRDS("C:/Users/HOME/OneDrive/proyects/geocoding_mex/2022/positive_denmx_2022_10_17_temp_geocoded.rds")
#data <- denhotspots::data_geocoden(infile = "positive_denmx_2022_10_17", 
#                                   data = TRUE,
#                                   sinave_new = TRUE)
#Step 5. save the results #####
#denhotspots::save_geocoden(x = z,
#                           y = data,
#                           directory = "9.RData_geocoded",
#                           loc = "positive_denmx_2022_10_17")

```
]

.panel[.panel-name[Paso 3. Save the dataset]
```{r geocoding_step_3, fig.show='hide', warning=FALSE, message=FALSE}
# Step 1. load geocoded dengue dataset of the current week ###

#load("C:/Users/HOME/OneDrive/proyects/geocoding_mex/2022/9.RData_geocoded/geo_den_mx_26_sonora_2022_09_26.RData")

#y <- y[stringr::str_which(y$formatted_address,  " Sonora|Son"),]


# Step 2 load geocoded dengue dataset of the last week ###
# load("C:/Users/HOME/OneDrive/proyects/geocoding_mex/2022/9.RData_geocoded/den22_sonora.RData")

# step 3. row binding ####
# z <- rbind(z, y)

# Step 4. save the results ####
#save(z, file = "9.RData_geocoded/den22_sonora.RData")

```
]
]

---
# Identificación de los Hotspots en R
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.panelset[

.panel[.panel-name[Dataset]
```{r}
# Step 1. load the dengue geocoded dataset ####
load("C:/Users/HOME/OneDrive/proyects/priority_research_projects/hotspots_high_risk_localities_138/8.RData/geocoded_dataset.RData")


```

]

.panel[.panel-name[Extract Locality]
```{r, message=FALSE, warning=FALSE}
# Step 2. extract the locality #####
x <- rgeomex::extract_ageb(locality = c("Guadalajara", "Zapopan", 
                                        "Tlaquepaque", "Tonalá"), 
                           cve_geo = "14")


```

]

.panel[.panel-name[Cases by AGEB]
```{r}
library(magrittr)
z <- denhotspots::point_to_polygons(x = y,
                                    y = x$ageb,
                                    ids = names(x$ageb)[-10],
                                    time = ANO,
                                    coords = c("long", "lat"),
                                    crs = 4326,
                                    dis = "DENV") 

```

]

.panel[.panel-name[Hotspots]
```{r}
hotspots <- denhotspots::gihi(x = z,
                              id = names(z)[c(1:9)], 
                              time = "year",
                              dis = "DENV",
                              gi_hi = "gi",
                              alpha = 0.95)

```

]



]

---
# Visualización
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.panelset.sideways[
```{r include=FALSE}
estatic_map <- c(source = "Static Map Code",
                 output = "Static Map")
interactive_map <- c(source = "Interactive Map Code",
                     output = "Interactive Map")
```
```{r panelset = estatic_map}
denhotspots::staticmap_intensity(x = hotspots,
                                 pal = rcartocolor::carto_pal,
                                 pal_name = TRUE,
                                 name = "OrYel",
                                 breaks = 1,
                                 dir_pal = -1,
                                 x_leg = 0.5,
                                 y_leg = 0.1,
                                 ageb = TRUE)
```
```{r panelset = interactive_map,  message=FALSE, warning=FALSE}
source("C:/Users/HOME/Dropbox/r_developments/r_dashboards/github_pages/test_dashboard/3.Functions/hotspots_map.R")
hotspots_map(cve_ent = "14",
             locality = c("Guadalajara", "Zapopan", 
                          "Tlaquepaque", "Tonalá"),
             hotspots = hotspots,
             static_map = FALSE)
```


]


---
# Dios Botic!
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">
&nbsp;

- ***Bio*** : https://fdzul.github.io/web_site_fadm/

- ***email***       :     felipe.dzul.m@gmail.com

- ***celular***     :     228 229 3419

- ***slides***:     https://animated-longma-729cee.netlify.app/talks/spatial_data/#1




.footnote[La presentación fue creada via [**xaringan**](https://github.com/yihui/xaringan),
[**revealjs**](https://revealjs.com/),
[remark.js](https://remarkjs.com), [**knitr**](http://yihui.name/knitr),
& [R Markdown](https://rmarkdown.rstudio.com) en [R]() & [RStudio](2.R_Scripts/libs/rstudio_leaflet/rstudio_leaflet.css).]