---
title: "Análisis Espacial del Dengue"
author: "Felipe Antonio Dzul Manzanilla"
date: '2022: Last compiled `r Sys.Date()`'
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: 
      - default
      - default-fonts
      - duke-blue
      - hygge-duke
      - libs/cc-fonts.css
      - libs/figure-captions.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r xaringan-fit-screen, echo=FALSE}
xaringanExtra::use_fit_screen()
```

```{r xaringanExtra, echo = FALSE}
xaringanExtra::use_progress_bar(color = "#0051BA", location = "top")
```

```{r xaringan-tachyons, echo=FALSE}
xaringanExtra::use_tachyons()
```

```{r share-again, echo=FALSE}
xaringanExtra::use_share_again()
```

```{r xaringan-logo, echo=FALSE}
xaringanExtra::use_logo(
  image_url = "https://www.gob.mx/cms/uploads/action_program/main_image/26942/post_post_portadavectores.gif",
  width = "110px",
  height = "228px",
  position = xaringanExtra::css_position(top = "1em", right = "1em")
)
```

```{r xaringan-panelset, echo=FALSE}
xaringanExtra::use_panelset()
```


### Ciclo de Vida del Programa de Prevención y Control del Dengue

```{r, dpi=300,echo=FALSE, fig.align ="center", out.height="100%",out.width = "100%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = circle, style = filled, color = grey,
  fixedsize = true, width = 2] 
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  ###########
  prog_den [label = 'Programa de Dengue',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
  brote [label = 'Brote',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
  cp [label = 'Control de Probables',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
  node [shape = circle, style = filled, color = grey] 
 
  
  ovitraps [label = 'Ovitrampas',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
  adult [label = 'Colecta de Adultos',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
  enc_ver [label = 'Encuesta Verificación',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
  plat [label = 'Plataforma',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
  
  #########
  node [shape = rectangle, style = filled, color = grey, fixedsize = true, width = 2.5] 
  act [label = 'Casos Actuales',  fillcolor = 'DarkOrange', color = 'white', fontcolor = 'black']
 
  epi [label = 'Vigilancia Epidemiológica',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  ent [label = 'Vigilancia Entomológica',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
 ind [label = 'Indicadores',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  ###################
  prog_den -> {epi, ent}[penwidth = 4]
  
  
  act -> {
  brote[arrowhead = crow, arrowtail = box, color = 'Maroon']
  cp[arrowhead = crow, arrowtail = box, color = 'Maroon']
  } -> plat[penwidth = 4]
  epi -> {act}[penwidth = 4]
  ent -> {adult, 
  ovitraps,
  enc_ver} -> plat[penwidth = 4]  
  plat -> ind[penwidth = 4]
  ind -> prog_den[penwidth = 4]
  #ind -> {enc_ver, ovitraps, adult, cl, irs, cp, brote}

 
 
 
  }", 
  height = 550)

```




---
### **Análisis Espacial de la Transmisión del Dengue**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE, out.width='100%', fig.align='center'}
DiagrammeR::grViz("digraph {
                  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, 
  style = filled, 
  color = grey, 
  nodesep = .5,
  fixedsize = true, 
  width = 2.5] 
  
  # edge definition
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  ##### epidemiological data
  
  epi [label = 'Vigilancia Epidemiológica',  fillcolor =  '#DB4437', color = 'white', fontcolor = 'white']
  data_historic [label = 'Datos Históricos',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_datos_actuales [label = 'Datos Actuales',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_acumulados [label = 'Datos Acumulados',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_trans_activa [label = 'Transmisión Activa',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  
  
  ##### Spatial Data
  
  areal [label = 'Areal Data',  fillcolor =  '#0F9D58', color = 'white', fontcolor = 'white']
  pp_data [label = 'Point Pattern Data',  fillcolor =  ' #0F9D58', color = 'white', fontcolor = 'white']
  
  
 
 # Análisis 
 hotspots [label = 'Hotspots Analysis',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 cadenas [label = 'Cadenas de Transmisión',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 cluster_ana [label = 'Cluster Analysis',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 lgcp [label = 'Spatial LGCP',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 
 
 # software
 
 geoda [label = 'Geoda',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 cluster_s [label = 'ClusterSeer',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 satscan [label = 'SatScan',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 
 r_rstudio [label = 'R & RStudio',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']

  denhotspot [label = 'denhotspots Package',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white'] 
 
 ##### define the relation
 
 epi -> {data_historic  data_datos_actuales}
 data_historic -> areal -> hotspots -> geoda
 data_datos_actuales -> {data_acumulados, data_trans_activa} -> pp_data -> {cadenas cluster_ana lgcp}
 cadenas -> cluster_s
 cluster_ana -> satscan
 
 {geoda cluster_s satscan lgcp} -> r_rstudio -> denhotspot
 
}")

```

---
### **Hotspots de la Transmisión del Dengue**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.pull-left[
1. Bajar las bases de datos del **[SINAVE](https://www.sinave.gob.mx/)**.
2. Geocodificar las bases.
3. Bajar los shapefile del **[INEGI](https://www.inegi.org.mx/)**.
4. Seleccionar la localidad de interes y extraer los AGEBs.
5. Contar el número de casos por AGEB.
6. Cálcular el Z-score de los casos.
7. Generar la matriz de adjacencias.
8. Cálcular el estadístico espacial local Getis&Ord $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$.
9. Realizar la la corrección de Bonferroni.
10. Cálcular los hotspots.
11. Visualizar los hotspots.
]
.pull-right[
```{r, dpi=300,echo=FALSE, fig.align ="center", out.width = "100%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  
  # flowchart for hotspots
  sinave [label = 'SINAVE',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  denv [label = 'Bases de DENV',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  geocode [label = 'Geocodificación',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  cases_ageb [label = 'Casos por AGEBs']
  z_score [label = 'Z-score']
  gi [label = 'Estadístico Espacial Local (Gi*)']
  bonferroni [label = 'Corrección de Bonferroni']
  hotspots [label = 'Hotspots', style = filled, color = orange]
  
  # flow chart for inegi
  inegi [label = 'INEGI', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  loc [label = 'Localidades Shapefile', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  ageb [label = 'AGEB Shapefile', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  loc_esp [label = 'Localidad de Ínteres', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  ageb_esp [label = 'AGEBs de la Localidad de Ínteres', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  mat [label = 'Matriz de Adjacencias', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  
  # edge definitions with the node IDs
  edge [color = black]
  sinave -> denv -> geocode -> cases_ageb -> z_score -> gi -> bonferroni -> hotspots 
  inegi -> {ageb, loc}
  loc -> loc_esp -> ageb_esp
  ageb -> ageb_esp
  ageb_esp -> mat
  mat -> cases_ageb 
 
  }", 
  height = 550)

```
]

.tiny[.blue[.footnote[ Dzul-Manzanilla et al 2021]]]


---
### Estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$ (Hotspots)
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

$$\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}}$$

donde:
 
$\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}$ el numerador, es la suma de los valores $x_{i}$ de la unidad espacial de interes con sus vecinos $x_{j}$ &
 
  

 
 $\frac{}{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}}$ el denominador, es la suma de todos los valores $x$ en toda la localidad de interes.


### **Hotspots** 
son las áreas o las unidades espaciales con valores altos de $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$ y homogéneos de la unidad espaciales de interes $x_{ij}$. En otras palabras el estadístico espacial, identifica las unidades espaciales $x_{ij}$ con valores altos comparados con el valor promedio de todas la unidades espaciales en la localidad de interes.



.tiny[.blue[.footnote[Getis & Ord 1991; Ord & Getis 1995]]]

---
### **Cadenas de Transmisión Knox test**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.pull-left[
1. Bajar las bases de datos del **[SINAVE](https://www.sinave.gob.mx/)**.
&nbsp;

2. Geocodificar las bases.
&nbsp;

3. Generar la base (onset y coordenadas).
&nbsp;

4. Aplicar el [**Knox test**]().
&nbsp;

5. Definir los [**Space-Time link**]().
&nbsp;

6. Visualizar [**Space-Time link**]().
]
.pull-right[
```{r, dpi=300,echo=FALSE, fig.align ="center", out.width = "100%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  
  
  
  # edge definition
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  # flowchart for sinave
  sinave [label = 'SINAVE',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  denv [label = 'Bases de DENV',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  geocode [label = 'Geocodificación',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
 
  
  # knox
  base [label = 'Genera la base (onset-coordenadas)',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
  
  knox [label = 'Knox test',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
  
  time_link [label = 'Space-Time Link',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
  
   vis [label = 'Visualización',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white'] 
  
  # edge definitions with the node IDs
  sinave -> denv -> geocode -> base -> knox -> time_link -> vis
  
   
 
  }", 
  height = 550)

```
]

.tiny[.blue[.footnote[]]]

---
### **Cadenas de Transmisión Knox test**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

$$\color{Orange}{Knox} = \frac{1}{2} \sum_{i=1}^{n}  \sum_{i=1}^{n} \color{Green}{S_{ij}} \color{red}{T_{ij}}$$
donde:

$\color{Green}{S_{ij}}$ = 1 si el caso $( i\ne j)$ & la $d_{ij} \le \delta^s$ (metros = 400), de lo contrario 0.

$\color{red}{T_{ij}}$ = 1 si el caso $( i\ne j)$ & la $d_{ij} \le \delta^t$ (dÍas = 20), de los contrario 0.

**Hipotesis Nula** las distancias temporales entre pares de casos son independientes de las distancias espaciales.

**Hipotesis Alternativa** existe dependencia de las distancias espaciales y temporales entre los pares de casos (existen cadenas de transmisión).


```{r echo=FALSE,dpi=300,warning=FALSE, fig.align ="center", out.width = "100%",fig.cap = "Tabla de contingencia de knox test"}
x <- data.frame("Close" = c("$0_{1}$", "$0_{3}$", "$S_{3}$"),
                "Not close" = c("$0_{2}$", "$0_{4}$", "$S_{4}$"),
                "Total" = c("$S_{1}$", "$S_{2}$", "$N$"))
row.names(x) <- c("Close in Space", "Not close in Space", "Total")
kableExtra::kbl(x, align = "c") |>
    kableExtra::kable_paper("striped", full_width = F) |>
    kableExtra::add_header_above(c(" " = 1, "Time" = 3)) |>
    kableExtra::pack_rows("",3, 3)

```


.tiny[.blue[.footnote[Viet et al 2015]]]

---
### **Log-Gaussian Cox Process**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.pull-left[
1. Bajar las bases de datos del **[SINAVE](https://www.sinave.gob.mx/)**.
&nbsp;

2. Geocodificar las bases.
&nbsp;

4. Aplicar el [**LGCP**]().
&nbsp;

5. Visualizar [** el modelo**]().
]
.pull-right[
```{r, dpi=300,echo=FALSE, fig.align ="center", out.width = "100%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  
  
  
  # edge definition
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  # flowchart for sinave
  sinave [label = 'SINAVE',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  denv [label = 'Bases de DENV',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
  geocode [label = 'Geocodificación',  fillcolor = '#0F9D58', color = 'white', fontcolor = 'white']
 
  
  # knox
  lgcp [label = 'LGCP',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
  
 
  
   vis [label = 'Visualización',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white'] 
  
  # edge definitions with the node IDs
  sinave -> denv -> geocode -> lgcp  -> vis
  
   
 
  }", 
  height = 550)

```
]

.tiny[.blue[.footnote[Moraga, 2020]]]



---
### **Log Gaussian Cox Process**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

 **Modelo General** 
$$ \varLambda{_s} = exp(n{_s})$$

El modelo asume que los casos han son una parcial realización de un proceso Gausiano (log-Gaussian).

 
 **Modelo en un Grid** 

$$\varLambda_{ij} = \int\limits_{s_{ij}}^{} exp(n(s))ds$$
$$\varLambda_{ij} \approx |s_{ij}| exp(n_{ij})$$
donde $|s_{ij}|$ es el área de la celda $s_{ij}$

$y_{ij}|n_{ij} \sim Poisson(|s_{ij}|exp(n_{ij}))$

$n_{ij} = \beta{_0} + \beta{_1} \space x \space cov (s_{ij}) + f{_s}(s_{ij}) + f{_u}(s_{ij})$

---
### **Análisis Espacial del Vector del Dengue**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE, out.width='100%', fig.align='center'}
DiagrammeR::grViz("digraph {
                  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, 
  style = filled, 
  color = grey, 
  nodesep = .5,
  fixedsize = true, 
  width = 2.5] 
  
  # edge definition
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  ##### entomological data
  
  ento [label = 'Vigilancia Entomológica',  fillcolor =  '#FF5A5F', color = 'white', fontcolor = 'white']
  data_historic [label = 'Datos Históricos',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  
  years  [label = '2014-2019',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_datos_actuales [label = 'Datos del Año Actual',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_acumulados [label = 'Datos hasta la Semana Actual',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_trans_activa [label = 'Semana Actual',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  
  
  ##### Spatial Data
  
  geo_data [label = 'Geoestatistical Data',  fillcolor =  '#0F9D58', color = 'white', fontcolor = 'white']
 
  
 
 # Análisis 
 spde [label = 'SPDE-INLA',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 hotspots [label = 'Hotspots Analysis',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 #prediction [label = 'Predicción Espacial de Huevos',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 
 # entomological study
 ovitraps [label = 'Ovitrampas',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
  enc_ver [label = 'Encuesta-Verificación',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
  adults [label = 'Colecta de Adultos',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 
 
 # software
 r_rstudio [label = 'R & RStudio',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 deneggs [label = 'deneggs Package',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white'] 
 
 
 
 
 ##### define the relation
 
 
 ento -> {ovitraps  enc_ver adults} 
 
 {ovitraps adults} -> geo_data -> {data_historic data_datos_actuales}
 data_historic -> years
 
 data_datos_actuales -> {data_acumulados data_trans_activa}
 
 {years data_acumulados data_trans_activa} ->spde -> hotspots
 
 {hotspots} -> r_rstudio -> deneggs
 
}")

```

---
### **Análisis Espacial del Vector del Dengue**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE,dpi=300,  fig.align ="center",out.height="70%", out.width = "90%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  #
  cenaprece [label = 'CENAPRECE',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  ovitrap [label = 'Ovitrampas',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  coord [label = 'Coordenadas',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  ovicoord [label = 'ovi + coord']
  
  # flow chart for inegi
  inegi [label = 'INEGI', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  loc [label = 'Localidades Shapefile', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']

  ###
  mesh [label = '1. Mesh']
  spde [label = '2. SPDE']
  
  proj_train [label = '3a. Projector Matrix A. Test']
  proj_test [label = '3b. Projector Matrix A. Train']
  
  spatial_field [label = '4. Spatial Field W']
  
  stack_train [label = '5a. Stack Train']
  stack_test [label = '5b. Stack Test']
  stack_pred [label = '5c. Stack Prediction']
  stack_joint [label = '6. Joint Stack']
  
  formula [label = '7. Formula']
  inla [label = '8. INLA',  fillcolor = 'Orange', color = 'white', fontcolor = 'white']
  
 
  
  # edge definitions with the node IDs
  cenaprece -> {ovitrap, coord} -> ovicoord
  #
  inegi -> loc -> ovicoord
  #
  ovicoord -> mesh
  mesh -> spde -> spatial_field ->  stack_joint
  spde -> {proj_train,  proj_test}
  spatial_field -> {stack_test, stack_train, stack_pred} ->  stack_joint -> formula -> inla 
  proj_train -> stack_train
  proj_test -> stack_test

  
  }", 
  height = 500)

```


.tiny[.blue[.footnote[ [Modificado de Zuur et al 2017](http://www.highstat.com/index.php/beginner-s-guide-to-regression-models-with-spatial-and-temporal-correlation); [Dzul-Manzanilla et al 2019](http://acaentmex.org/entomologia/revista/2019/EMF/EMF%20497-501.pdf)]]]


---
### **Análisis Espacial del Vector del Dengue**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE,dpi=300, fig.align ="center", out.height="70%", out.width = "90%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  #
  
  inla [label = '8. INLA',  fillcolor = 'Orange', color = 'white', fontcolor = 'white']
  stat [label = '9. Statistics']
  
  zeros [label = '9.1. % Zeros']
  disp [label = '9.2. Dispersion Statistics']
  dic [label = '9.3. Deviance Information Criterio']
  pear [label = '9.4. Pearson Residuals']
  
  ##
  p [label = 'Poisson']
  zip [label = 'ZeroInflated Poisson']
  nb [label = 'Negative Binomial']
  zinb [label = 'ZeroInflated Poisson Negative Binomial']
  
  sel [label = '10.Select the Distribution & Model']
  
  # prediction ####
  ext_pred [label = '11. Extract Index Prediction']
  coor_pred [label = '12. Extract Coordinates Prediction']
  pred [label = '13. Prediction']
 
  hotspots [label = '14.Hotspots', fillcolor = 'Orange', color = 'white', fontcolor = 'white']
  save [label = '15. Save results']
  
  mappred [label = '15a. Prediction Map']
  hotspotsb [label = '15b. Hotspots']
  dics [label = '15c. DICs']
  loc [label = '15d. Locality']
  data [label = '15e. Dataset']
  
  # edge definitions with the node IDs
  inla -> stat
  stat -> {zeros, disp, dic,pear} -> {p, zip, nb, zinb} -> sel
  sel -> ext_pred -> coor_pred -> pred -> hotspots -> save
  save -> {mappred, hotspotsb, dics, loc, data}

  
  }", 
  height = 500)

```


.tiny[.blue[.footnote[ [Modificado de Zuur et al 2017](http://www.highstat.com/index.php/beginner-s-guide-to-regression-models-with-spatial-and-temporal-correlation); [Dzul-Manzanilla et al 2019](http://acaentmex.org/entomologia/revista/2019/EMF/EMF%20497-501.pdf)]]]



---
### **Analisis Geoéstadistico con INLA**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">
.pull-left[
```{r echo=FALSE, warning=FALSE,depi = 300, message=FALSE, out.height="100%", out.width="100%",fig.align='center'}
# Step 1. create the function for extract the locality 
extract_locality <- function(cve_edo, locality){
    rgeomex::loc_inegi19_mx |>
        dplyr::filter(CVE_ENT %in% c(cve_edo)) |>
        dplyr::filter(NOMGEO %in% c(rgeomex::find_most_similar_string(locality, unique(NOMGEO)))) |>
        sf::st_make_valid()
}

# step 2. extract the locality ####
y <- extract_locality(cve_edo = "14",
                         locality = c("Guadalajara", "Zapopan", "Tlaquepaque", "Tonalá"))

# Step 3. Generate the points ####
x <- sf::st_sample(x = y,
                   size = 30,
                   type = "regular") |>
    sf::st_set_crs(value = 4326) |>
    sf::st_as_sf() |>
    dplyr::mutate(id = paste("s", 1:length(x), sep = ""))

ggplot2::ggplot() +
    ggplot2::geom_sf(data = y,
                     alpha = 0.5,
                     fill = "gray85") +
    cowplot::theme_map() +
    ggplot2::geom_sf(data = x,
                     color = "#36C5F0",
                     size = 3) +
    ggplot2::geom_sf_text(data = x, 
                          ggplot2::aes(label = id),
                          size = 4,
                          nudge_x = 0.009,
                          nudge_y = 0.001,
                          color = "#2EB67D")
```
]

.pull-right[

$s{_i}$ sitios de colecta con coordenadas geográficas (longitud. latitud).
&nbsp;

$D$ area de estudio (zona metropolitana de Guadalajara).
&nbsp;

$Y{_i}$ es la variable de respuesta (Número de Huevos por Ovitrampa o Manzana).
&nbsp;

$y{_i}$ tiene una distribución (binomial negativa ó zibn).
&nbsp;

$U{_s{_i}}$ el efecto espacial & el proceso ocurre en un campo gaussiano continuo (Gaussian Field).





]

Se usa SPDE & Elemento Finito para aproximar la matriz de covarianzas de $U{_s{_i}}$

$\color{#2ECC40}{el \space proceso \space se \space encuentra \space implementado \space en \space INLA}$

---
### **Análisis Espacial del Dengue de México en R**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">


Paquetes en R desarrollados por el Programa ([denhotspots](https://fdzul.github.io/denhotspots/) & [deneggs](https://github.com/fdzul/deneggs)) para el análisis espacial.

```{r, echo=FALSE, message=FALSE, warning=FALSE}

tibble::tibble("Análisis"= c("Hotspots",
                             "Visualización de los Hotspots",
                             "Cadenas de Transmisión",
                             "Visualiación de las Cadenas de Transmisión",
                             "LGCP",
                             "Visualización de LGCP",
                             "Hotspots de Huevos",
                             "Visualización de Hotspots"),
               "denhotspots" = c(T,T, T, T,
                                T, T,F, F),
               "deneggs" = c(F, F, F, F,
                             F, F, T, T)) |>
    kableExtra::kable() |>
    kableExtra::kable_classic()

```
---
### **Hotspots de la Transmisión del Dengue**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.panelset[

.panel[.panel-name[Dataset]
```{r}
# Step 1. load the dengue geocoded dataset ####
load("C:/Users/HOME/OneDrive/proyects/priority_research_projects/hotspots_high_risk_localities_138/8.RData/geocoded_dataset.RData")


```

]

.panel[.panel-name[Extract Locality]
```{r, message=FALSE, warning=FALSE}
# Step 2. extract the locality #####
x <- rgeomex::extract_ageb(locality = c("Guadalajara", "Zapopan", 
                                        "Tlaquepaque", "Tonalá"), 
                           cve_geo = "14")


```

]

.panel[.panel-name[Cases by AGEB]
```{r}
library(magrittr)
z <- denhotspots::point_to_polygons(x = y,
                                    y = x$ageb,
                                    ids = names(x$ageb)[-10],
                                    time = ANO,
                                    coords = c("long", "lat"),
                                    crs = 4326,
                                    dis = "DENV") 

```

]

.panel[.panel-name[Hotspots]
```{r}
hotspots <- denhotspots::gihi(x = z,
                              id = names(z)[c(1:9)], 
                              time = "year",
                              dis = "DENV",
                              gi_hi = "gi",
                              alpha = 0.95)

```

]

]



---
### **Hotspots de la Transmisión del Dengue**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.panelset.sideways[
```{r include=FALSE}
estatic_map <- c(source = "Static Map Code",
                 output = "Static Map")
interactive_map <- c(source = "Interactive Map Code",
                     output = "Interactive Map")
```

```{r panelset = estatic_map}
denhotspots::staticmap_intensity(x = hotspots,
                                 pal = rcartocolor::carto_pal,
                                 pal_name = TRUE,
                                 name = "OrYel",
                                 breaks = 1,
                                 dir_pal = -1,
                                 x_leg = 0.5,
                                 y_leg = 0.1,
                                 ageb = TRUE)
```

```{r panelset = interactive_map,  message=FALSE, warning=FALSE}
source("C:/Users/HOME/Dropbox/r_developments/r_dashboards/github_pages/test_dashboard/3.Functions/hotspots_map.R")
hotspots_map(cve_ent = "14",
             locality = c("Guadalajara", "Zapopan", 
                          "Tlaquepaque", "Tonalá"),
             hotspots = hotspots,
             static_map = FALSE)
```


]

---
### **Cadenas de Transmisión Knox test**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.panelset.sideways[
```{r include=FALSE}
knox_merida_prob <- c(source = "Código",
                      output = "Probables")
knox_merida_conf <- c(source = "Código",
                      output = "Confirmados")
```
```{r panelset = knox_merida_prob, warning=FALSE, message=FALSE}
# Step 1. load the dengue cases geocoded
load("C:/Users/HOME/OneDrive/proyects/geocoding_mex/2022/9.RData_geocoded/geo_den_mx_31_merida_2022_10_31.RData")

# Step 2. visualize the space-time link 
denhotspots::transmission_chains_map(geocoded_dataset = y,
                                     cve_edo = "31",
                                     locality = "Merida",
                                     dengue_cases = "Probable")

```


```{r panelset = knox_merida_conf, warning=FALSE, message=FALSE}
# Step 1. load the dengue cases geocoded
load("C:/Users/HOME/OneDrive/proyects/geocoding_mex/2022/9.RData_geocoded/geo_den_mx_31_merida_2022_10_31.RData")

# Step 2. visualize the space-time link 
denhotspots::transmission_chains_map(geocoded_dataset = y,
                                     cve_edo = "31",
                                     locality = "Merida",
                                     dengue_cases = "Confirmado")

```

]

---
### **Log Gaussian Cox Process**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.panelset.sideways[
```{r include=FALSE}
lgcp_merida <- c(source = "Código",
                 output = "Merida")
lgcp_hermosillo <- c(source = "Código",
                     output = "Hermosillo")
```
```{r panelset = lgcp_merida, warning=FALSE, message=FALSE}
# Step 1. load the dengue geocoded dataset ####
load("C:/Users/HOME/OneDrive/proyects/geocoding_mex/2022/9.RData_geocoded/den2022_positivos.RData")



# Step 2. extract the dengue cases #####
geocoded_dataset <- z |>
    dplyr::filter(ESTATUS_CASO == 2) |>
    dplyr::mutate(onset = FEC_INI_SIGNOS_SINT,
                  date = as.character(onset),
                  id = VEC_ID) |>
    dplyr::mutate(x = long,
                  y = lat) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326) |>
    dplyr::select(x, y, onset) 

# Step 3. extract the locality ####
loc <- rgeomex::extract_locality(cve_edo = 31,
                                 locality = "Mérida")


# Step 4. extract the dengue cases of the locality 
geocoded_dataset <- geocoded_dataset[loc,] |>
    sf::st_drop_geometry()


# Step 5. map of lgcp 
library(magrittr)
library(ggplot2)
library(sf)
library(sp)
library(plotly)

 denhotspots::spatial_lgcp(dataset = geocoded_dataset,
                          locality = "Merida",
                          cve_edo = "31",
                          longitude = "x",
                          latitude = "y",
                          k = 30,
                          plot = FALSE,
                          aproximation = "gaussian",
                          integration = "laplace",
                          resolution = 0.015,
                          approach = "lattice",
                          cell_size = 1500,
                          name = "YlGnBu")$map

```


```{r panelset = lgcp_hermosillo, warning=FALSE, message=FALSE}
# Step 1. load the dengue cases geocoded
load("C:/Users/HOME/OneDrive/proyects/geocoding_mex/2022/9.RData_geocoded/geo_den_mx_31_merida_2022_10_31.RData")

# Step 2. visualize the space-time link 
denhotspots::transmission_chains_map(geocoded_dataset = y,
                                     cve_edo = "31",
                                     locality = "Merida",
                                     dengue_cases = "Confirmado")

```

]


---
### **Dashboard**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">





---
## Dios Botic!
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">
&nbsp;

- ***Bio*** : https://fdzul.github.io/web_site_fadm/

- ***email***       :     [felipe.dzul.m@gmail.com]()

- ***celular***     :     [8139945623]()

- ***slides***:     https://animated-longma-729cee.netlify.app/talks/spatial_analysis_dengue/#1





.footnote[La presentación fue creada via [**xaringan**](https://github.com/yihui/xaringan),
[**revealjs**](https://revealjs.com/),
[remark.js](https://remarkjs.com), [**knitr**](http://yihui.name/knitr),
& [R Markdown](https://rmarkdown.rstudio.com) en [R]() & [RStudio](2.R_Scripts/libs/rstudio_leaflet/rstudio_leaflet.css).]

