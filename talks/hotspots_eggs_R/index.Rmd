---
title: "Hotspots del Vector del Dengue en R"
author: "Felipe Antonio Dzul Manzanilla"
date: '2022: Last compiled `r Sys.Date()`'
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: 
      - default
      - default-fonts
      - duke-blue
      - hygge-duke
      - libs/cc-fonts.css
      - libs/figure-captions.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

class: left, top

```{r xaringan-fit-screen, echo=FALSE}
xaringanExtra::use_fit_screen()
```

```{r xaringanExtra, echo = FALSE}
xaringanExtra::use_progress_bar(color = "#0051BA", location = "top")
```

```{r xaringan-tachyons, echo=FALSE}
xaringanExtra::use_tachyons()
```

```{r share-again, echo=FALSE}
xaringanExtra::use_share_again()
```

```{r xaringan-logo, echo=FALSE}
xaringanExtra::use_logo(
  image_url = "https://www.gob.mx/cms/uploads/action_program/main_image/26942/post_post_portadavectores.gif",
  width = "110px",
  height = "228px",
  position = xaringanExtra::css_position(top = "1em", right = "1em")
)
```

# Conceptos $\color{#2ECC40}s_{\color{#2ECC40}i}$, $\color{#2ECC40}D$, & $\color{#2ECC40}u_{\color{#2ECC40}{si}}$
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">
.pull-left[
```{r echo=FALSE, warning=FALSE,depi = 300, message=FALSE, out.height="100%", out.width="100%",fig.align='center'}
# Step 1. create the function for extract the locality 
extract_locality <- function(cve_edo, locality){
    rgeomex::loc_inegi19_mx |>
        dplyr::filter(CVE_ENT %in% c(cve_edo)) |>
        dplyr::filter(NOMGEO %in% c(rgeomex::find_most_similar_string(locality, unique(NOMGEO)))) |>
        sf::st_make_valid()
}

# step 2. extract the locality ####
y <- extract_locality(cve_edo = "14",
                         locality = c("Guadalajara", "Zapopan", "Tlaquepaque", "Tonala"))

# Step 3. Generate the points ####
x <- sf::st_sample(x = y,
                   size = 30,
                   type = "regular") |>
    sf::st_set_crs(value = 4326) |>
    sf::st_as_sf() |>
    dplyr::mutate(id = paste("s", 1:length(x), sep = ""))

ggplot2::ggplot() +
    ggplot2::geom_sf(data = y,
                     alpha = 0.5,
                     fill = "gray85") +
    cowplot::theme_map() +
    ggplot2::geom_sf(data = x,
                     color = "#36C5F0",
                     size = 3) +
    ggplot2::geom_sf_text(data = x, 
                          ggplot2::aes(label = id),
                          size = 4,
                          nudge_x = 0.009,
                          nudge_y = 0.001,
                          color = "#2EB67D")
```
]

.pull-right[

$s{_i}$ sitios de colecta con coordenadas geográficas (longitud. latitud).
&nbsp;

$D$ area de estudio (zona metropolitana de Guadalajara).
&nbsp;

$Y{_i}$ es la variable de respuesta (Número de Huevos por Ovitrampa o Manzana).
&nbsp;

$y{_i}$ tiene una distribución (binomial negativa ó zibn).
&nbsp;

$U{_s{_i}}$ el efecto espacial & el proceso ocurre en un campo gaussiano continuo (Gaussian Field).
]

---
# Análisis Geoestadístico de Ovitrampas
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.pull-left[
Modelo sin correlación espacial
\begin{align*}
Huevos & = \beta{_0} + \beta x + \epsilon{_i} \\
\beta{_0} & = intercepto \\
\beta x & =  pendiente \\
\epsilon{_i} & = error \\
\epsilon{_i} &\sim {\sf Norm}(0, \sigma^2) \\
\end{align*}

Modelo con efecto espacial
\begin{align*}
Huevos & = \beta{_0} + \beta x + u{_i}+\epsilon{_i} \\
Huevos & = \beta{_0} + u{_i}+\epsilon{_i} \\
u{_i} & = efecto espacial \\
u{_i} &\sim {\sf GF}(0, \sum) \\
\end{align*}

]

.pull-rigth[
Cuando D es regular
&nbsp;

Se usa Gausian Makovian RF (GMRF) para aproximar la matriz de covarianzas

&nbsp;

Cuando D es irregular
&nbsp;
&nbsp;

Se usa SPDE & Elemento Finito para aproximar la matriz de covarianzas


]


---
# SPDE y elemento finito
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.pull-left[
SPDE
&nbsp;

$$(K^2-\Delta)^{a/2}U(s) = W(s)$$

Elemento Finito
&nbsp;

$$u(s) = \sum_{i=1}^{G} \alpha{_k}(s{_i})W{_k}$$
]

.pull-right[
```{r, echo=FALSE, warning=FALSE, message=FALSE, dpi = 300}
set.seed(123)
s <- cbind(x1 = runif(5),
           y1 = runif(5))
mesh <- INLA::inla.mesh.2d(loc = s, 
                           max.edge = 1)
plot(mesh)
par(new=TRUE)
plot(s, pch = 16, cex = 2, col = "red")

# Numero de vertices (G)
mesh$n

```
]

---
## **Calculo de $\alpha{_k}$**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.pull-left[
![Alt text](https://becarioprecario.bitbucket.io/spde-gitbook/figs/spde-intro-interp2d-1.png "Figure 2.8. Kraisky et al 2019")
]

.pull-right[
-  Coordenadas en los vértices
&nbsp;

   Sí $s{_i}$ caé en el vértice 1, el resto 0.
   $u(s) = w{_k}$

-  Cordenadas dentro del Triángulo
&nbsp;

   Sí $s{_i}$ caé dentro del triángulo
   se ponderan los tres puntos
   $$u(s) = \sum_{i=1}^{G} \alpha{_k}(s{_i})W{_k}$$
   
   $$0.17 * W{_1} + 0.54 * W{_3} + 0.29 * W{_3}$$

- Coordenadas sobre un borde
&nbsp;
  
  Sí $s{_i}$ caé en el borde
  se ponderan los dos valores 
  
  $$u(s) = \sum_{i=1}^{G} \alpha{_k}(s{_i})W{_k}$$

]
---
## **Análisis Geoestadístico de Ovitrampas en R**

```{r xaringan-panelset, echo=FALSE}
xaringanExtra::use_panelset()
```

.panelset.sideways[
```{r include=FALSE}
spde_gua_mesh <- c(source = "Código",
                   output = "Mesh")
spde_gua_mesh_zoom <- c(source = "Codigo",
                        output  = "Mesh zoom")


```

```{r panelset = spde_gua_mesh, dpi = 300, out.width='100%',out.height="100%", warning=FALSE, message=FALSE}
x <- deneggs::eggs_hotspots(path_lect = "C:/Users/HOME/Dropbox/cenaprece_datasets/2022/14_jalisco",
                       cve_ent = "14",
                       locality  = c("Guadalajara", "Zapopan",
                                     "Tlaquepaque", "Tonala"),
                       path_coord = "C:/Users/HOME/Dropbox/cenaprece_datasets/2022/14_jalisco/DescargaOvitrampasMesFco.txt",
                       longitude  = "Pocision_X",
                       latitude =  "Pocision_Y",
                       aproximation = "gaussian",
                       integration = "eb",
                       fam = "zeroinflatednbinomial1",
                       k = 30,
                       palette_vir  = "magma",
                       leg_title = "Huevos",
                       plot = FALSE,
                       hist_dataset = FALSE,
                       sem = 41,
                       var = "eggs",
                       cell_size = 2000,
                       alpha = .99)
ggplot2::ggplot() +
    inlabru::gg(x$mesh) +
    ggplot2::geom_point(data = x$data,
                        ggplot2::aes(x = x$data$Pocision_X,
                                     y = x$data$Pocision_Y),
                        col = "red")

```

```{r panelset = spde_gua_mesh_zoom, out.width='100%', dpi = 300, out.height="100%",warning=FALSE, message=FALSE}
x <- deneggs::eggs_hotspots(path_lect = "C:/Users/HOME/Dropbox/cenaprece_datasets/2022/14_jalisco",
                       cve_ent = "14",
                       locality  = c("Guadalajara", "Zapopan",
                                     "Tlaquepaque", "Tonala"),
                       path_coord = "C:/Users/HOME/Dropbox/cenaprece_datasets/2022/14_jalisco/DescargaOvitrampasMesFco.txt",
                       longitude  = "Pocision_X",
                       latitude =  "Pocision_Y",
                       aproximation = "gaussian",
                       integration = "eb",
                       fam = "zeroinflatednbinomial1",
                       k = 30,
                       palette_vir  = "magma",
                       leg_title = "Huevos",
                       plot = FALSE,
                       hist_dataset = FALSE,
                       sem = 41,
                       var = "eggs",
                       cell_size = 2000,
                       alpha = .99)
ggplot2::ggplot() +
    inlabru::gg(x$mesh) +
    ggplot2::geom_point(data = x$data,
                        ggplot2::aes(x = x$data$Pocision_X,
                                     y = x$data$Pocision_Y),
                        col = "red") +
    ggplot2::coord_sf(xlim = c(-103.30, -103.28),
                      ylim = c(20.60, 20.61))

```

]



---
## **Análisis Geoestadístico de Ovitrampas en R**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">


## 1. Instalar el paquete **INLA**. 

## 2. Instalar el paquete **deneggs**. 
&nbsp;

## 3. Definir la ruta de los archivos de las lecturas y las coordenadas.
&nbsp;

## 4. Definir la localidad de interes y la clave del estado.
&nbsp;

## 5. Correr la función **deneggs::eggs_hotspots**.



---
# Análisis Geoestadístico de Ovitrampas
## Definición de argumentos.

```{r echo=FALSE}
tibble::tibble(argumento = c("path_lect", "path_coord", "year","locality",  "cve_ent",
                             "leg_title", "fam", "alpha", "plot", "aproximation"),
    definicion = c("Ruta de ovitrampas", "Ruta de la coordenadas", "Año a analizar", "localidad", "Clave del Estado",
                   "Título de la leyenda", "Nombre de la Distribución", "Nivel de Significancia", "Valor lógico para visualizar el mesh", "Es el método de aproximación para calcular los hiperparametros y valores marginales. Las opciones son gaussian, simplified.laplace & laplace")) |>
    kableExtra::kable() |>
    kableExtra::kable_classic()
```

---
# Análisis Geoestadístico de Ovitrampas
## Definición de argumentos.

```{r echo=FALSE}
tibble::tibble(argumento = c("integration", "longitude", "latitude", "k", "sem", "var",
                             "cell_size", "palette_vir", "hist_dataset"),
    definicion = c("Es la estrategia de integración. Las opciones son grid, eb & ccd)",
                   "Coordenada geográfica (longitud)", "Coordenada geográfica (latitud)", "es un parametro pera definir los triangules exteriores e interiores",
                   "Es la semana epidemiológica",
                   "Es la variable de interes",
                   "Es el tamaño de muestra para predecir",
                   "es la paleta de viridis. Las opciones son magma, inferno, plasma & viridis",
                   "Es un valor lógico para definir las bases históricas (FALSE) ó la actual base de ovitrampas(FALSE)")) |>
    kableExtra::kable() |>
    kableExtra::kable_classic()
```

---
# Análisis Geoestadístico de Ovitrampas


.panelset.sideways[
```{r include=FALSE}
spde_gua_elementos <- c(source = "Código",
                        output = "Elementos")
spde_gua_map <- c(source = "Codigo",
                  output  = "Mapa")


```

```{r panelset = spde_gua_elementos, out.width='100%', warning=FALSE, message=FALSE}
names(deneggs::eggs_hotspots(path_lect = "C:/Users/HOME/Dropbox/cenaprece_datasets/2022/14_jalisco",
                       cve_ent = "14",
                       locality  = c("Guadalajara", "Zapopan",
                                     "Tlaquepaque", "Tonala"),
                       path_coord = "C:/Users/HOME/Dropbox/cenaprece_datasets/2022/14_jalisco/DescargaOvitrampasMesFco.txt",
                       longitude  = "Pocision_X",
                       latitude =  "Pocision_Y",
                       aproximation = "gaussian",
                       integration = "eb",
                       fam = "zeroinflatednbinomial1",
                       k = 30,
                       palette_vir  = "magma",
                       leg_title = "Huevos",
                       plot = FALSE,
                       hist_dataset = FALSE,
                       sem = 41,
                       var = "eggs",
                       cell_size = 2000,
                       alpha = .99))

```

```{r panelset = spde_gua_map, out.width='100%', warning=FALSE, message=FALSE}
deneggs::eggs_hotspots(path_lect = "C:/Users/HOME/Dropbox/cenaprece_datasets/2022/14_jalisco",
                       cve_ent = "14",
                       locality  = c("Guadalajara", "Zapopan",
                                     "Tlaquepaque", "Tonala"),
                       path_coord = "C:/Users/HOME/Dropbox/cenaprece_datasets/2022/14_jalisco/DescargaOvitrampasMesFco.txt",
                       longitude  = "Pocision_X",
                       latitude =  "Pocision_Y",
                       aproximation = "gaussian",
                       integration = "eb",
                       fam = "zeroinflatednbinomial1",
                       k = 30,
                       palette_vir  = "magma",
                       leg_title = "Huevos",
                       plot = FALSE,
                       hist_dataset = FALSE,
                       sem = 41,
                       var = "eggs",
                       cell_size = 2000,
                       alpha = .99)$map

```

]
---
# Dios Botic!
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">
&nbsp;

- ***Bio*** : https://fdzul.github.io/web_site_fadm/

- ***email***       :     [felipe.dzul.m@gmail.com]()

- ***celular***     :     [8139945623]()

- ***slides***:     https://animated-longma-729cee.netlify.app/talks/hotspots_eggs_R/#1





.footnote[La presentación fue creada via [**xaringan**](https://github.com/yihui/xaringan),
[**revealjs**](https://revealjs.com/),
[remark.js](https://remarkjs.com), [**knitr**](http://yihui.name/knitr),
& [R Markdown](https://rmarkdown.rstudio.com) en [R]() & [RStudio](2.R_Scripts/libs/rstudio_leaflet/rstudio_leaflet.css).]