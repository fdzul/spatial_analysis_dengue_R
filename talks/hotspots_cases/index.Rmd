---
title: "Hotspots de la Transmisión de Dengue"
author: "Felipe Antonio Dzul Manzanilla"
date: '2022: Last compiled `r Sys.Date()`'
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: 
      - default
      - default-fonts
      - duke-blue
      - hygge-duke
      - libs/cc-fonts.css
      - libs/figure-captions.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

class: left, top

```{r xaringan-fit-screen, echo=FALSE}
xaringanExtra::use_fit_screen()
```

```{r xaringanExtra, echo = FALSE}
xaringanExtra::use_progress_bar(color = "#0051BA", location = "top")
```

```{r xaringan-tachyons, echo=FALSE}
xaringanExtra::use_tachyons()
```

```{r share-again, echo=FALSE}
xaringanExtra::use_share_again()
```

```{r xaringan-logo, echo=FALSE}
xaringanExtra::use_logo(
  image_url = "https://www.gob.mx/cms/uploads/action_program/main_image/26942/post_post_portadavectores.gif",
  width = "110px",
  height = "228px",
  position = xaringanExtra::css_position(top = "1em", right = "1em")
)
```

## **Análisis espacial del dengue**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE, out.width='100%', fig.align='center'}
DiagrammeR::grViz("digraph {
                  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, 
  style = filled, 
  color = grey, 
  nodesep = .5,
  fixedsize = true, 
  width = 2.5] 
  
  # edge definition
  edge [color = grey, arrowhead = normal, arrowtail = dot]
  
  ##### epidemiological data
  
  epi [label = 'Vigilancia Epidemiológica',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_historic [label = 'Datos Históricos',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_datos_actuales [label = 'Datos Actuales',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_acumulados [label = 'Datos Acumulados',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  data_trans_activa [label = 'Transmisión Activa',  fillcolor =  'gray', color = 'white', fontcolor = 'white']
  
  
  ##### Spatial Data
  
  areal [label = 'Areal Data',  fillcolor =  '#0F9D58', color = 'white', fontcolor = 'white']
  pp_data [label = 'Point Pattern Data',  fillcolor =  ' #0F9D58', color = 'white', fontcolor = 'white']
  
  
 
 # Análisis 
 hotspots [label = 'Hotspots Analysis',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 cadenas [label = 'Cadenas de Transmisión',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 cluster_ana [label = 'Cluster Analysis',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 lgcp [label = 'Spatial LGCP',  fillcolor =  'orange', color = 'white', fontcolor = 'black']
 
 
 # software
 
 geoda [label = 'Geoda',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 cluster_s [label = 'ClusterSeer',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 satscan [label = 'SatScan',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']
 
 r_rstudio [label = 'R & RStudio',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white']

  denhotspot [label = 'denhotspots Package',  fillcolor =  'DodgerBlue', color = 'white', fontcolor = 'white'] 
 
 ##### define the relation
 
 epi -> {data_historic  data_datos_actuales}
 data_historic -> areal -> hotspots -> geoda
 data_datos_actuales -> {data_acumulados, data_trans_activa} -> pp_data -> {cadenas cluster_ana lgcp}
 cadenas -> cluster_s
 cluster_ana -> satscan
 
 {geoda cluster_s satscan lgcp} -> r_rstudio -> denhotspot
 
}")

```

---
# **Hotspots de Dengue**
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

.pull-left[
1. Bajar las bases de datos del **[SINAVE](https://www.sinave.gob.mx/)**.
2. Geocodificar las bases.
3. Bajar los shapefile del **[INEGI](https://www.inegi.org.mx/)**.
4. Seleccionar la localidad de interes y extraer los AGEBs.
5. Contar el número de casos por AGEB.
6. Cálcular el Z-score de los casos.
7. Generar la matriz de adjacencias.
8. Cálcular el estadístico espacial local Getis&Ord $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$.
9. Realizar la la corrección de Bonferroni.
10. Cálcular los hotspots.
11. Visualizar los hotspots.
]
.pull-right[
```{r, dpi=300,echo=FALSE, fig.align ="center", out.width = "100%"}
DiagrammeR::grViz("digraph {

  # graph definitions
  graph [layout = dot, rankdir = TB]
  
  # node definitions
  node [shape = rectangle, style = filled, color = grey] 
  
  # flowchart for hotspots
  sinave [label = 'SINAVE',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  denv [label = 'Bases de DENV',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  geocode [label = 'Geocodificación',  fillcolor = 'SeaGreen', color = 'white', fontcolor = 'white']
  cases_ageb [label = 'Casos por AGEBs']
  z_score [label = 'Z-score']
  gi [label = 'Estadístico Espacial Local (Gi*)']
  bonferroni [label = 'Corrección de Bonferroni']
  hotspots [label = 'Hotspots', style = filled, color = orange]
  
  # flow chart for inegi
  inegi [label = 'INEGI', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  loc [label = 'Localidades Shapefile', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  ageb [label = 'AGEB Shapefile', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  loc_esp [label = 'Localidad de Ínteres', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  ageb_esp [label = 'AGEBs de la Localidad de Ínteres', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  mat [label = 'Matriz de Adjacencias', fillcolor = 'DeepSkyBlue', color = 'white', fontcolor = 'black']
  
  # edge definitions with the node IDs
  edge [color = black]
  sinave -> denv -> geocode -> cases_ageb -> z_score -> gi -> bonferroni -> hotspots 
  inegi -> {ageb, loc}
  loc -> loc_esp -> ageb_esp
  ageb -> ageb_esp
  ageb_esp -> mat
  mat -> cases_ageb 
 
  }", 
  height = 550)

```
]

.tiny[.blue[.footnote[ Dzul-Manzanilla et al 2021]]]

---
### Estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$ (Hotspots)
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

$$\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}}$$

donde:
 
$\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}$ el numerador, es la suma de los valores $x_{j}$ de la unidad espacial de interes $x_{ij}$ &
 
  

 
 $\frac{}{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}}$ el denominador, es la suma de todos los valores $x$ en toda la localidad de interes.


### **Hotspots** 
son las áreas o las unidades espaciales con valores altos de $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$ y homogéneos de la unidad espaciales de interes $x_{ij}$. En otras palabras el estadístico espacial, identifica las unidades espaciales $x_{ij}$ con valores altos comparados con el valor promedio de todas la unidades espaciales en la localidad de interes.



.tiny[.blue[.footnote[ Getis & Ord 1991; Ord & Getis 1995]]]


---
### Cálculo del estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

```{r, echo=FALSE,dpi=300, warning = FALSE,message = FALSE,out.width = "80%"}
# Step 2. load the locality ####
x <- rgeomex::extract_ageb(locality = "Homun", cve_geo = "31")

#  Step 2. simulate dengue cases ####
set.seed(123456)
x$ageb$nb_n <- MASS::rnegbin(n = nrow(x$ageb),
                             mu = 10,
                             theta = 0.2)
row.names(x$ageb) <- stringr::str_sub(row.names(x$ageb),
                                      start = 3,
                                      end = -1)
# Step 4. mapa de cases #####
library(ggplot2)
ggplot2::ggplot()+
    ggplot2::geom_sf(data = x$ageb,
                     ggplot2::aes(fill = as.factor(nb_n)),
                     label = rownames(x$ageb)) +
    ggplot2::scale_fill_viridis_d("Casos") +
    ggplot2::theme_void() +
    ggplot2::geom_sf_label(data = x$ageb,
                           ggplot2::aes(label = rownames(x$ageb)),
                           label.size = 0.1,
                           size = 2.5,
                           alpha = 0.5) +
    ggplot2::ggtitle("Homun, Yuc.")

```


---
### Cálculo del estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">


Spatial Weight Matrix $\color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}$

```{r swm, echo=FALSE, warning = FALSE,message = FALSE, fig.align ="left", out.width = "50%"}
# Create the neighborhoods ####
nb_q <- spdep::nb2listw(spdep::poly2nb(x$ageb), style="B", zero.policy=TRUE)

# Crate the matrix ####
library(Matrix)
library(spatialreg)
matrix <- as(as(nb_q, "CsparseMatrix"), "matrix")
df <- as.data.frame(matrix)

library(magrittr)
library(kableExtra)
kableExtra::kbl(df) %>%
  kable_styling(bootstrap_options = "striped", full_width = T, font_size = 20)
```

Casos por cada unidad espacial $\color{#FF4136}x_{\color{#FF4136}i}$

```{r swm_casos, echo=FALSE, warning = FALSE,message = FALSE, fig.align ="left", out.width = "50%"}
y_matriz <- matrix(data = x$ageb$nb_n,
                   nrow = 1, 
                   ncol = nrow(x$ageb))
colnames(y_matriz) <- row.names(y_matriz)
dimnames(y_matriz) <- list("casos", row.names(x$ageb))

kableExtra::kbl(y_matriz) %>%
  kable_styling(bootstrap_options = "striped", full_width = T, font_size = 20)
```



---
### Cálculo del estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

&nbsp;

$$\color{#2ECC40}{G_{i}^{*}} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{1+ 1}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} = \frac{\color{#FF4136}{2}}{\color{#0074D9}{209}}= \color{#2ECC40}{0.009569378}$$

$$\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{17 + 1 + 5 + 37 + 0}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{60}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.2870813}$$

$$\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{17 + 1 + 0}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{18}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.0861244}$$

$$\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{1 + 37}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{38}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.1818182}$$



---
### Cálculo del estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

&nbsp;

$$\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{37 + 0}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{37}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.1770335}$$

$$\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{1 + 5 + 148 + 0}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{154}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.7368421}$$


$$\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{1 + 1 +148 + 37}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{187}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.8947368}$$


$$\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*} = \frac{\color{#FF4136}\sum_{\color{#FF4136}j \color{#FF4136}= \color{#FF4136}1}^\color{#FF4136}{n} \color{#FF4136}w_{\color{#FF4136}i\color{#FF4136}j}\color{#FF4136}x_{\color{#FF4136}j}}
{\color{#0074D9}\sum_{\color{#0074D9}j \color{#0074D9}= \color{#0074D9}1}^{\color{#0074D9}n} \color{#0074D9}x_{\color{#0074D9}j}} = \frac{\color{#FF4136}{0}}{\color{#0074D9}{17 + 1 + 1 + 5 + 148 +37 + 0 + 0}} =  \frac{\color{#FF4136}{0}}{\color{#0074D9}{209}} =\color{#2ECC40}{0.0000000}$$

---
### Cálculo del estadístico Espacial Local $\color{#2ECC40}G_{\color{#2ECC40}i}^{\color{#2ECC40}*}$
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

&nbsp;

.pull-left[

```{r, echo=FALSE}
x$ageb |>
    dplyr::select(nb_n) |>
    sf::st_drop_geometry() |>
    #dplyr::mutate(casos_vecinos = c(2, 60, 18, 38, 37, 154, 187, 0)) |>
    dplyr::mutate(getis = c(2, 60, 18, 38, 37, 154, 187, 0)/sum(nb_n)) |>
    dplyr::mutate(z_score = (getis-mean(getis))/sd(getis)) |>
kableExtra::kbl() |>
    kableExtra::kable_styling(bootstrap_options = "striped", 
                              full_width = T, font_size = 20)
```
]

.pull-right[
Corrección de Bonferroni: 

$1-\alpha$ = $(1-\alpha)^{n}$

$n = 8, alpha = c(.95, 0.99)$
```{r, echo=FALSE}
 getis_ord_umbral <- function(n, alpha){
        round(qnorm(p = -((1-alpha)/n) + 1, mean = 0, sd = 1), digits = 4)
 }

getis_ord_umbral(n = c(8), alpha = c(.95, .99))
```

Criterio:

Si
$$\color{#2ECC40}{G_{i}^{*}} >= 1-\alpha = (1-\alpha)^{n}$$
es Hotspots, de lo contrario es no Hotspots
]
---
# Thanks!
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">
&nbsp;

- ***Bio*** : https://fdzul.github.io/web_site_fadm/

- ***email***       :     [felipe.dzul.m@gmail.com]()

- ***celular***     :     [228 229 3419]()

- ***slides***:     https://animated-longma-729cee.netlify.app/talks/hotspots_cases/#1





.footnote[La presentación fue creada via [**xaringan**](https://github.com/yihui/xaringan),
[**revealjs**](https://revealjs.com/),
[remark.js](https://remarkjs.com), [**knitr**](http://yihui.name/knitr),
& [R Markdown](https://rmarkdown.rstudio.com) en [R]() & [RStudio](2.R_Scripts/libs/rstudio_leaflet/rstudio_leaflet.css).]
